<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>มอบหมายงาน - ระบบจัดการชั้นเรียน</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="classroom.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
      /* CSS สำหรับ <input class="weight-input"> และ <input disabled-weighted> */
      .weight-input {
        width: 70px;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
        text-align: center;
      }
      .weight-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.4);
      }
      .disabled-weighted {
        background-color: #f5f5f5;
        color: var(--light-text-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px;
        width: 70px;
        text-align: center;
      }
      .btn-download {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 18px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn-download:hover {
        background-color: var(--button-blue-hover);
      }
    </style>
  </head>
  <body>
    <div class="sidebar" id="sidebar">
      <button
        class="sidebar-toggle-btn"
        onclick="toggleSidebar()"
        aria-label="สลับแถบข้าง"
      >
        <span class="material-icons">menu</span>
      </button>
      <div class="logo-section">
        <span class="material-icons logo-icon">menu_book</span>
        <span class="logo-text">ระบบจัดการชั้นเรียน</span>
      </div>
      <nav>
        <ul>
          <li>
            <a href="index.html"
              ><span class="material-icons">home</span
              ><span class="menu-label">หน้าแรก</span></a
            >
          </li>
          <li>
            <a href="#" id="classLink"
              ><span class="material-icons">school</span
              ><span class="menu-label">ห้องเรียน</span></a
            >
          </li>
          <li>
            <a href="#" id="assignmentsLink"
              ><span class="material-icons">assignment</span
              ><span class="menu-label">มอบหมายงาน</span></a
            >
          </li>
          <li>
            <a href="#" id="attendanceLink"
              ><span class="material-icons">event_note</span
              ><span class="menu-label">ข้อมูลการเข้าเรียน</span></a
            >
          </li>
          <li>
            <a href="#" id="summaryLink"  class="active"
              ><span class="material-icons">bar_chart</span
              ><span class="menu-label">คะแนนรวม</span></a
            >
          </li>
        </ul>
      </nav>
     
    </div>

    <div class="main-content">
      <div class="assignment-table-section">
        <h2>ตารางคะแนนงาน (รวมสัดส่วน)</h2>
        <!-- ตัวอย่าง: วางปุ่มไว้ใต้ตารางคะแนน -->
        <div class="score-table-container">
          <button
            id="btnDownloadExcel"
            class="btn-download"
            style="margin-bottom: 10px"
          >
            <span class="material-icons">file_download</span>
            ดาวน์โหลด Excel
          </button>
          <table class="score-table" id="scoreTable">
            <thead>
              <tr id="scoreTableHeaderRow">
                <!-- Dynamic Headers -->
              </tr>
            </thead>
            <tbody id="scoreTableBody">
              <tr>
                <td
                  colspan="5"
                  style="text-align: center; color: var(--light-text-color)"
                >
                  กำลังโหลดข้อมูลนักเรียนและงาน...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

       
      </div>
    </div>

    <script>
      // ===== Firebase Config =====
      const firebaseConfig = {
        apiKey: "AIzaSyCTyiR22AHeiKzI7Yr0g-V_dmdVPeh4ybo",
        authDomain: "kru-digital.firebaseapp.com",
        projectId: "kru-digital",
        storageBucket: "kru-digital.firebasestorage.app",
        messagingSenderId: "464969597852",
        appId: "1:464969597852:web:7763a74cc042f231717e59",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let currentClassId = "";
      let studentsData = {}; // { studentId: { firstName, lastName, studentNo } }
      let assignmentsData = {}; // { assignmentId: { name, maxScore, weightScore, createdAt } }
      let studentScores = {}; // { studentId: { [assignmentId]: rawScore, specialScore: rawSpecial } }

      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        currentClassId = urlParams.get("class") || "";
        if (!currentClassId) {
          alert("ไม่พบ Class ID กรุณาเลือกห้องเรียนจากหน้าหลัก");
          window.location.href = "index.html";
          return;
        }

        // ปรับลิงก์ใน Sidebar ให้มี ?class={currentClassId}
        document.querySelectorAll(".sidebar nav ul li a").forEach((link) => {
          const label = link.querySelector(".menu-label")?.textContent.trim();
          if (label === "ห้องเรียน")
            link.href = `class_management.html?class=${currentClassId}`;
          if (label === "มอบหมายงาน")
            link.href = `assignments.html?class=${currentClassId}`;
          if (label === "ข้อมูลการเข้าเรียน")
            link.href = `attendance.html?class=${currentClassId}`;
          if (label === "คะแนนรวม")
            link.href = `summary.html?class=${currentClassId}`;
        });

        // โหลดข้อมูลทั้งหมด
        loadAllData(currentClassId);
      };

      function loadAllData(classId) {
        // โหลดนักเรียน
        db.ref(`classes/${classId}/students`).on(
          "value",
          (snap) => {
            studentsData = snap.val() || {};
            renderScoreTable();
          },
          (err) => console.error(err)
        );

        // โหลดมอบหมายงาน
        db.ref(`classes/${classId}/assignments`).on(
          "value",
          (snap) => {
            assignmentsData = snap.val() || {};
            // ถ้าไม่มี weightScore ให้ตั้งเป็น maxScore เริ่มต้น
            Object.entries(assignmentsData).forEach(([aid, asg]) => {
              if (asg.weightScore == null) {
                assignmentsData[aid].weightScore = asg.maxScore;
                db.ref(`classes/${classId}/assignments/${aid}/weightScore`)
                  .set(asg.maxScore)
                  .catch(console.error);
              }
            });
            renderScoreTable();
          },
          (err) => console.error(err)
        );

        // โหลดคะแนน
        db.ref(`classes/${classId}/scores`).on(
          "value",
          (snap) => {
            studentScores = snap.val() || {};
            renderScoreTable();
          },
          (err) => console.error(err)
        );
      }

      function renderScoreTable() {
        const headerRow = document.getElementById("scoreTableHeaderRow");
        const tableBody = document.getElementById("scoreTableBody");
        headerRow.innerHTML = "";
        tableBody.innerHTML = "";

        // --- สร้าง Header ---
        // (เพิ่มบรรทัดนี้ ก่อนบรรทัดที่สร้าง thName เดิม)
        const thNo = document.createElement("th");
        thNo.textContent = "เลขที่";
        headerRow.appendChild(thNo);

        // เดิมมีบรรทัด:
        const thName = document.createElement("th");
        thName.textContent = "ชื่อนักเรียน";
        headerRow.appendChild(thName);

        const sortedAssignmentIds = Object.keys(assignmentsData).sort(
          (a, b) => {
            const dA = new Date(assignmentsData[a].createdAt || 0);
            const dB = new Date(assignmentsData[b].createdAt || 0);
            return dA - dB;
          }
        );

        sortedAssignmentIds.forEach((aid) => {
          const asg = assignmentsData[aid];
          if (!asg) return;
          const w = parseFloat(asg.weightScore) || 0;
          const th = document.createElement("th");
          th.className = "assignment-name-header";
          th.innerHTML = `
          ${asg.name}<br>
          (เดิม ${asg.maxScore} คะแนน)<br>
          <label style="font-weight:600; font-size:0.9rem; margin-top:5px; display:block;">
            คะแนนเต็มใหม่:
            <input 
              type="number" 
              min="0" step="0.1"
              value="${w}"
              data-assignment-id="${aid}"
              class="weight-input"
            />
          </label>
        `;
          headerRow.appendChild(th);
        });

        // หา maxSpecialAll
        let maxSpecialAll = 0;
        Object.keys(studentsData).forEach((sid) => {
          const sp =
            (studentScores[sid] && studentScores[sid].specialScore) != null
              ? parseFloat(studentScores[sid].specialScore)
              : 0;
          if (sp > maxSpecialAll) maxSpecialAll = sp;
        });

        // เพิ่มหัวตาราง “คะแนนพิเศษ”
        const thSpecial = document.createElement("th");
        thSpecial.textContent = "คะแนนพิเศษ";
        thSpecial.className = "assignment-name-header";
        headerRow.appendChild(thSpecial);

        // เพิ่มหัวตาราง “คะแนนรวม (เต็ม 100)”
        const thTotal = document.createElement("th");
        thTotal.textContent = "คะแนนรวม (เต็ม 100)";
        thTotal.className = "score-total-col";
        headerRow.appendChild(thTotal);

        // เพิ่มหัวตาราง “เกรด”
        const thGrade = document.createElement("th");
        thGrade.textContent = "เกรด";
        thGrade.className = "score-total-col";
        headerRow.appendChild(thGrade);

        // --- สร้าง Body ---
        const sortedStudentIds = Object.keys(studentsData).sort((a, b) => {
          const sa = studentsData[a],
            sb = studentsData[b];
          const na = parseInt(sa.studentNo),
            nb = parseInt(sb.studentNo);
          if (!isNaN(na) && !isNaN(nb)) return na - nb;
          return (sa.firstName || "").localeCompare(sb.firstName || "");
        });

        // ถ้าไม่มีนักเรียน
        if (sortedStudentIds.length === 0) {
          const colspan = sortedAssignmentIds.length + 3;
          tableBody.innerHTML = `
          <tr>
            <td colspan="${colspan}" style="text-align:center; color: var(--light-text-color);">
              ยังไม่มีนักเรียนในห้องเรียนนี้
            </td>
          </tr>
        `;
          attachWeightListeners();
          return;
        }

        // หาผลรวม weightScore ของ assignments
        let sumWeightAssignments = 0;
        sortedAssignmentIds.forEach((aid) => {
          sumWeightAssignments +=
            parseFloat(assignmentsData[aid].weightScore) || 0;
        });

        sortedStudentIds.forEach((sid) => {
          const stu = studentsData[sid];
          const row = tableBody.insertRow();
          row.id = `studentRow-${sid}`;

          // ชื่อนักเรียน
          const noCell = row.insertCell();
          noCell.textContent = stu.studentNo || "-";
          noCell.style.fontWeight = "600";
          noCell.style.textAlign = "center";

          // เดิมมีบรรทัด:
          const nameCell = row.insertCell();
          nameCell.className = "student-name-col";
          nameCell.textContent = `${stu.firstName || ""} ${stu.lastName || ""}`;
          let sumAdjusted = 0;

          // แต่ละ assignment
          sortedAssignmentIds.forEach((aid) => {
            const asg = assignmentsData[aid];
            const maxScore = parseFloat(asg.maxScore) || 0;
            const weightScore = parseFloat(asg.weightScore) || maxScore;
            const raw =
              studentScores[sid] && studentScores[sid][aid] != null
                ? parseFloat(studentScores[sid][aid])
                : 0;
            const safeRaw = raw > maxScore ? maxScore : raw;
            const adj = maxScore > 0 ? safeRaw * (weightScore / maxScore) : 0;
            sumAdjusted += adj;

            const cell = row.insertCell();
            const input = document.createElement("input");
            input.type = "number";
            input.readOnly = true;
            input.className = "disabled-weighted";
            input.value = adj.toFixed(2);
            cell.appendChild(input);
          });

          // คะแนนพิเศษ
          const rawSpecial =
            studentScores[sid] && studentScores[sid].specialScore != null
              ? parseFloat(studentScores[sid].specialScore)
              : 0;
          const safeSpecial =
            rawSpecial > maxSpecialAll ? maxSpecialAll : rawSpecial;
          const adjSpecial = maxSpecialAll > 0 ? safeSpecial : 0;
          sumAdjusted += adjSpecial;

          const specialCell = row.insertCell();
          const spInput = document.createElement("input");
          spInput.type = "number";
          spInput.readOnly = true;
          spInput.className = "disabled-weighted";
          spInput.value = adjSpecial.toFixed(2);
          specialCell.appendChild(spInput);

          // คำนวณคะแนนรวม normalized to 100
          const denom = sumWeightAssignments + maxSpecialAll;
          const normalized = denom > 0 ? (sumAdjusted / denom) * 100 : 0;
          const totalCell = row.insertCell();
          totalCell.className = "score-total-col";
          totalCell.id = `totalScoreDisplay-${sid}`;
          totalCell.textContent = `${Math.min(normalized, 100).toFixed(
            2
          )} / 100`;

          // เกรด
          const gradeCell = row.insertCell();
          gradeCell.className = "score-total-col";
          const normClamped = Math.min(normalized, 100);
          gradeCell.textContent = calculateGrade(normClamped);
        });

        attachWeightListeners();
      }

      function calculateGrade(score) {
        if (score >= 80) return "4.0";
        if (score >= 75) return "3.5";
        if (score >= 70) return "3.0";
        if (score >= 65) return "2.5";
        if (score >= 60) return "2.0";
        if (score >= 55) return "1.5";
        if (score >= 50) return "1.0";
        return "0";
      }

      function attachWeightListeners() {
        document.querySelectorAll(".weight-input").forEach((input) => {
          input.addEventListener("change", (e) => {
            const assignmentId = e.target.dataset.assignmentId;
            let val = parseFloat(e.target.value);
            if (isNaN(val) || val < 0) val = 0;
            e.target.value = val;

            // บันทึก weightScore ใหม่ แล้ว render ใหม่ทั้งตาราง
            db.ref(
              `classes/${currentClassId}/assignments/${assignmentId}/weightScore`
            )
              .set(val)
              .then(() => {
                renderScoreTable();
              })
              .catch((err) => {
                console.error(err);
                alert("เกิดข้อผิดพลาดในการบันทึกน้ำหนักคะแนน");
              });
          });
        });
      }

      // ฟังก์ชันแปลง <table> เป็น CSV string
      function tableToCSV(tableElement) {
        const rows = Array.from(tableElement.querySelectorAll("tr"));
        const csvLines = rows.map((row) => {
          const cells = Array.from(row.querySelectorAll("th, td"));
          // ดึงแต่เนื้อหา text ของแต่ละเซลล์
          const line = cells.map((cell) => {
            let text = cell.textContent.trim();
            // ถ้ามี input ภายใน ให้ดึงค่า value แทน textContent
            const input = cell.querySelector("input");
            if (input) {
              text = input.value;
            }
            // ถ้ามี <br> ให้แทนที่ด้วยช่องว่าง
            text = text.replace(/\r?\n|\r/g, " ");
            // Escape เครื่องหมายจุลภาค / quote
            if (
              text.includes(",") ||
              text.includes('"') ||
              text.includes("\n")
            ) {
              text = '"' + text.replace(/"/g, '""') + '"';
            }
            return text;
          });
          return line.join(",");
        });
        return csvLines.join("\r\n");
      }

      // ฟังก์ชันดาวน์โหลดไฟล์ CSV
      function downloadCSV(csvContent, filename) {
        const bom = "\uFEFF"; // ใส่ BOM เพื่อให้ Excel อ่านชื่อไทยได้ถูกต้อง
        const blob = new Blob([bom + csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      // ผูก event ให้ปุ่มดาวน์โหลด
      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("btnDownloadExcel");
        if (!btn) return;

        btn.addEventListener("click", () => {
          // หา element ตาราง (ในตัวอย่าง id="scoreTable")
          const table = document.getElementById("scoreTable");
          if (!table) {
            alert("ไม่พบตารางคะแนน");
            return;
          }
          // แปลงเป็น CSV
          const csv = tableToCSV(table);
          // ตั้งชื่อไฟล์ ตามวันเวลา หรือชื่อที่ต้องการ
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, "0");
          const dd = String(now.getDate()).padStart(2, "0");
          const hh = String(now.getHours()).padStart(2, "0");
          const mi = String(now.getMinutes()).padStart(2, "0");
          const filename = `คะแนนงาน_${yyyy}${mm}${dd}_${hh}${mi}.csv`;
          // ดาวน์โหลดไฟล์
          downloadCSV(csv, filename);
        });
      });
    </script>
  </body>
</html>
